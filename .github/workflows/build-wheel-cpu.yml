name: Build Wheels (CPU)

on:
  workflow_dispatch:
  push:
    tags: ["v*"]

jobs:
  build-cpu:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            python-version: "3.14"
            cibw_build: cp39-manylinux_x86_64 cp310-manylinux_x86_64 cp311-manylinux_x86_64 cp312-manylinux_x86_64 cp313-manylinux_x86_64 cp314-manylinux_x86_64
            cibw_skip: "*-musllinux_*"
            cibw_image: manylinux_2_28
            cibw_repair: ""
          - os: windows-latest
            platform: windows
            python-version: "3.14"
            cibw_build: cp39-win_amd64 cp310-win_amd64 cp311-win_amd64 cp312-win_amd64 cp313-win_amd64 cp314-win_amd64
            cibw_skip: ""
            cibw_image: ""
            cibw_repair: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install cibuildwheel
        run: |
          uv pip install --system -U cibuildwheel wheel
        shell: bash

      - name: Build wheels (CPU only)
        env:
          CIBW_BUILD: ${{ matrix.cibw_build }}
          CIBW_SKIP: ${{ matrix.cibw_skip }}
          CIBW_BUILD_VERBOSITY: 1
          CIBW_MANYLINUX_X86_64_IMAGE: ${{ matrix.cibw_image }}
          CIBW_REPAIR_WHEEL_COMMAND: ${{ matrix.cibw_repair }}
          CIBW_ENVIRONMENT: >-
            CMAKE_ARGS="-DGGML_CUDA=OFF -DGGML_METAL=OFF -DGGML_VULKAN=OFF -DGGML_BLAS=OFF -DGGML_NATIVE=OFF"
        run: |
          cibuildwheel --output-dir wheelhouse
        shell: bash

      - name: List built wheels
        run: |
          ls -lh wheelhouse/*.whl || dir wheelhouse\*.whl
        shell: bash

      - name: Upload wheels as artifact
        uses: actions/upload-artifact@v6
        with:
          name: wheelhouse-${{ matrix.platform }}
          path: wheelhouse/*.whl

      - uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2
        with:
          files: wheelhouse/*.whl
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
