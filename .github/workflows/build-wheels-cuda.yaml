name: Build Wheels (CUDA)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_linux:
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:${{ matrix.cuda_config.ver }}-devel-ubuntu22.04
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        pyver: ["3.9", "3.10", "3.11", "3.12", "3.13"]
        cuda_config:
          - ver: 12.1.1
            short: cu121
            arch: 75;80;86;89;90
          - ver: 12.2.2
            short: cu122
            arch: 75;80;86;89;90
          - ver: 12.3.2
            short: cu123
            arch: 75;80;86;89;90
          - ver: 12.4.1
            short: cu124
            arch: 75;80;86;89;90
          - ver: 12.6.3
            short: cu126
            arch: 75;80;86;89;90;100
          - ver: 12.8.1
            short: cu128
            arch: 75;80;86;89;90;100
    name: Linux CUDA ${{ matrix.cuda_config.ver }} Py ${{ matrix.pyver }}
    env:
      CUDAVER: ${{ matrix.cuda_config.ver }}

    steps:
      - name: Install system dependencies
        run: |
          apt update && apt install -y build-essential cmake git libssl-dev software-properties-common

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python ${{ matrix.pyver }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.pyver }}
          cache: pip

      - name: Install uv
        run: |
          python -m pip install --upgrade uv

      - name: Verify environment
        run: |
          python --version
          uv --version
          which python
          nvcc --version

      - name: Install build dependencies
        run: |
          uv pip install build wheel setuptools packaging

      - name: Build wheel
        env:
          VERBOSE: 1
          CMAKE_ARGS: >-
            -DGGML_CUDA=on
            -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.cuda_config.arch }}
            -DGGML_CUDA_FORCE_MMQ=OFF
            -DGGML_AVX=off -DGGML_AVX2=off -DGGML_FMA=off -DGGML_F16C=off
        run: |
          python -m build --wheel

      - name: List wheels
        run: ls -lh dist/*.whl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-cuda-${{ matrix.pyver }}-${{ matrix.cuda_config.short }}
          path: dist/*.whl

  build_windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    strategy:
      fail-fast: false
      matrix:
        pyver: ["3.9", "3.10", "3.11", "3.12", "3.13"]
        cuda_config:
          - ver: 12.4.1
            short: cu124
            arch: 75;80;86;89;90
          - ver: 12.6.3
            short: cu126
            arch: 75;80;86;89;90;100
          - ver: 12.8.1
            short: cu128
            arch: 75;80;86;89;90;100
    name: Windows CUDA ${{ matrix.cuda_config.ver }} Py ${{ matrix.pyver }}
    env:
      CUDAVER: ${{ matrix.cuda_config.ver }}

    steps:
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install CUDA toolkit
        uses: N-Storm/cuda-toolkit@v0.2.29
        with:
          cuda: ${{ matrix.cuda_config.ver }}
          use-github-cache: true

      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.pyver }}
          enable-cache: true

      - name: Enable long paths
        run: git config --system core.longpaths true

      - name: Build wheel
        env:
          VERBOSE: 1
          CMAKE_ARGS: >-
            -DGGML_CUDA=on
            -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.cuda_config.arch }}
            -DGGML_CUDA_FORCE_MMQ=OFF
            -DGGML_AVX=off -DGGML_AVX2=off -DGGML_FMA=off -DGGML_F16C=off
        run: |
          uv pip install build wheel setuptools packaging
          python -m build --wheel

      - name: List wheels
        run: Get-ChildItem dist/*.whl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-cuda-${{ matrix.pyver }}-${{ matrix.cuda_config.short }}-win
          path: dist/*.whl
