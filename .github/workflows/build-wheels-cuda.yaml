name: Build Wheels (CUDA)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_linux:
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:${{ matrix.cuda_config.ver }}-devel-ubuntu22.04
    strategy:
      fail-fast: false
      matrix:
        cuda_config:
          - ver: 12.1.1
            short: cu121
            arch: 75;80;86;89;90
          - ver: 12.2.2
            short: cu122
            arch: 75;80;86;89;90
          - ver: 12.3.2
            short: cu123
            arch: 75;80;86;89;90
          - ver: 12.4.1
            short: cu124
            arch: 75;80;86;89;90
        pyver: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    name: Linux CUDA ${{ matrix.cuda_config.ver }} Py ${{ matrix.pyver }}
    steps:
      - name: Install system deps (including real cmake) and deadsnakes PPA
        run: |
          apt update && apt install -y software-properties-common git curl build-essential cmake libssl-dev
          add-apt-repository ppa:deadsnakes/ppa -y
          apt update
          apt install -y python${{ matrix.pyver }} python${{ matrix.pyver }}-dev python${{ matrix.pyver }}-distutils python${{ matrix.pyver }}-venv

      - name: Set Python symlink and install pip + uv
        run: |
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.pyver }} 1
          update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.pyver }} 1
          curl https://bootstrap.pypa.io/get-pip.py | python
          python -m pip install --upgrade uv

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify CUDA and Python
        run: |
          python --version
          uv --version
          which python
          cmake --version
          nvcc --version
          nvidia-smi || true

      - name: Install build dependencies (using --system)
        run: |
          uv pip install --system build wheel setuptools packaging

      - name: Build wheel
        env:
          VERBOSE: 1
          CMAKE_ARGS: >-
            -DGGML_CUDA=on
            -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.cuda_config.arch }}
            -DGGML_CUDA_FORCE_MMQ=OFF
            -DGGML_AVX=off -DGGML_AVX2=off -DGGML_FMA=off -DGGML_F16C=off
        run: python -m build --wheel

      - name: List wheels (check for +cu tag)
        run: ls -lh dist/*.whl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-cuda-${{ matrix.pyver }}-${{ matrix.cuda_config.short }}
          path: dist/*.whl

  build_windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - pyver: "3.9"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.10"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.11"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.12"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          # Agregá más versiones nuevas aquí (12.6, 12.8) fácilmente
    name: Windows CUDA ${{ matrix.cuda }} Py ${{ matrix.pyver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install CUDA toolkit
        uses: N-Storm/cuda-toolkit@v0.2.29
        with:
          cuda: ${{ matrix.cuda }}
          use-github-cache: true

      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.pyver }}
          enable-cache: true

      - name: Enable long paths
        run: git config --system core.longpaths true

      - name: Install build tools
        run: uv pip install build wheel cmake setuptools packaging

      - name: Build wheel
        env:
          VERBOSE: 1
          CMAKE_ARGS: >-
            -DGGML_CUDA=on
            -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.arch }}
            -DGGML_CUDA_FORCE_MMQ=OFF
            -DGGML_AVX=off -DGGML_AVX2=off -DGGML_FMA=off -DGGML_F16C=off
        run: python -m build --wheel

      - name: List wheels
        run: Get-ChildItem dist/*.whl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-cuda-${{ matrix.pyver }}-${{ matrix.short }}-win
          path: dist/*.whl
