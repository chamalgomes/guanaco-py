name: Build Wheels (CUDA)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_linux:
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:${{ matrix.cuda_config.ver }}-devel-ubuntu24.04
    strategy:
      fail-fast: false
      matrix:
        cuda_config:
          - ver: 13.0.2
            short: cu130
            arch: 89;
          - ver: 13.1.1
            short: cu131
            arch: 75;80;
        pyver: ["3.13", "3.14"]
    name: Linux CUDA ${{ matrix.cuda_config.ver }} Py ${{ matrix.pyver }}
    steps:
      - name: Install system dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "tzdata tzdata/Areas select America" | debconf-set-selections
          echo "tzdata tzdata/Zones/America select New_York" | debconf-set-selections
          ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime

          apt update && apt install -y software-properties-common git curl build-essential cmake libssl-dev
          add-apt-repository ppa:deadsnakes/ppa -y
          apt update
          apt install -y python${{ matrix.pyver }} python${{ matrix.pyver }}-dev python${{ matrix.pyver }}-venv

      - name: Set Python symlink and install pip + uv
        run: |
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.pyver }} 1
          update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.pyver }} 1

          if [[ "${{ matrix.pyver }}" < "3.12" || "${{ matrix.pyver }}" == "3.11" ]]; then
            python -m ensurepip --upgrade
          else
            curl https://bootstrap.pypa.io/get-pip.py | python --
          fi

          python -m pip install --upgrade uv

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify CUDA and Python
        run: |
          python --version
          uv --version
          which python
          cmake --version
          nvcc --version
          nvidia-smi || true

      - name: Install build dependencies
        run: |
          uv pip install --system build wheel setuptools packaging

      - name: Build wheel
        env:
          VERBOSE: 1
          CMAKE_ARGS: >-
            -DGGML_CUDA=on
            -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.cuda_config.arch }}
            -DGGML_CUDA_FORCE_MMQ=OFF
            -DGGML_AVX=off -DGGML_AVX2=off -DGGML_FMA=off -DGGML_F16C=off
            -DLLAMA_BUILD_EXAMPLES=OFF
            -DLLAMA_BUILD_TESTS=OFF
            -DLLAMA_BUILD_SERVER=OFF
            -DLLAVA_BUILD=off
            -DCMAKE_EXE_LINKER_FLAGS="-L/usr/local/cuda/lib64/stubs -lcuda"
        run: python -m build --wheel

      - name: List wheels
        run: ls -lh dist/*.whl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-cuda-${{ matrix.pyver }}-${{ matrix.cuda_config.short }}
          path: dist/*.whl

      - uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2
        with:
          files: dist/*.whl
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
